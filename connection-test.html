<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè™šæ‹Ÿå®¢æœ - è¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #4c1d95;
            margin-bottom: 10px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
        }
        .test-section.success {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .test-section.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .test-section.warning {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
        .qr-code {
            text-align: center;
            margin: 20px 0;
        }
        .qr-code img {
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .url-display {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
        }
        .status.success {
            background: #10b981;
            color: white;
        }
        .status.error {
            background: #ef4444;
            color: white;
        }
        .status.warning {
            background: #f59e0b;
            color: white;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #4c1d95;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: bold;
            margin: 5px;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background: #5b21b6;
        }
        .btn.secondary {
            background: #6b7280;
        }
        .btn.secondary:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIè™šæ‹Ÿå®¢æœè¿æ¥æµ‹è¯•</h1>
            <p>ä¸­æ’åˆ›ä¸–ç§‘æŠ€ - æ‰«ç æœåŠ¡è¯Šæ–­å·¥å…·</p>
        </div>

        <!-- ç¯å¢ƒæ£€æµ‹ -->
        <div class="test-section" id="env-section">
            <h3>ğŸ“ ç¯å¢ƒæ£€æµ‹</h3>
            <p><strong>å½“å‰URL:</strong> <span id="current-url"></span></p>
            <p><strong>åè®®:</strong> <span id="protocol"></span></p>
            <p><strong>åŸŸå:</strong> <span id="hostname"></span></p>
            <p><strong>ç«¯å£:</strong> <span id="port"></span></p>
            <p><strong>è·¯å¾„:</strong> <span id="pathname"></span></p>
        </div>

        <!-- äºŒç»´ç ç”Ÿæˆæµ‹è¯• -->
        <div class="test-section" id="qr-section">
            <h3>ğŸ“± äºŒç»´ç ç”Ÿæˆæµ‹è¯•</h3>
            <div id="qr-results"></div>
        </div>

        <!-- é¡¹ç›®è®¿é—®æµ‹è¯• -->
        <div class="test-section" id="project-section">
            <h3>ğŸ”— é¡¹ç›®è®¿é—®æµ‹è¯•</h3>
            <div id="project-results"></div>
        </div>

        <!-- APIè¿æ¥æµ‹è¯• -->
        <div class="test-section" id="api-section">
            <h3>ğŸ”Œ APIè¿æ¥æµ‹è¯•</h3>
            <div id="api-results"></div>
        </div>

        <!-- ä¿®å¤å»ºè®® -->
        <div class="test-section" id="fix-section">
            <h3>ğŸ”§ ä¿®å¤å»ºè®®</h3>
            <div id="fix-results"></div>
        </div>
    </div>

    <script>
        // ç¯å¢ƒæ£€æµ‹
        function detectEnvironment() {
            const currentUrl = window.location.href;
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = window.location.port || 'é»˜è®¤ç«¯å£';
            const pathname = window.location.pathname;

            document.getElementById('current-url').textContent = currentUrl;
            document.getElementById('protocol').textContent = protocol;
            document.getElementById('hostname').textContent = hostname;
            document.getElementById('port').textContent = port;
            document.getElementById('pathname').textContent = pathname;

            // åˆ¤æ–­ç¯å¢ƒçŠ¶æ€
            const envSection = document.getElementById('env-section');
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                envSection.className = 'test-section warning';
                envSection.innerHTML += '<p><span class="status warning">å¼€å‘ç¯å¢ƒ</span> å½“å‰åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ</p>';
            } else {
                envSection.className = 'test-section success';
                envSection.innerHTML += '<p><span class="status success">ç”Ÿäº§ç¯å¢ƒ</span> å½“å‰åœ¨ç”Ÿäº§ç¯å¢ƒ</p>';
            }
        }

        // äºŒç»´ç ç”Ÿæˆæµ‹è¯•
        function testQRGeneration() {
            const testProjects = ['p1', 'proj_1', 'proj_2'];
            const qrResults = document.getElementById('qr-results');
            
            testProjects.forEach(projectId => {
                // ä½¿ç”¨ä¿®å¤åçš„URLç”Ÿæˆé€»è¾‘
                const port = window.location.port ? `:${window.location.port}` : '';
                const productGuideUrl = `${window.location.protocol}//${window.location.hostname}${port}${window.location.pathname}#/view/${projectId}`;
                const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(productGuideUrl)}&color=7c3aed&bgcolor=ffffff`;
                
                const projectDiv = document.createElement('div');
                projectDiv.innerHTML = `
                    <h4>é¡¹ç›® ${projectId}</h4>
                    <div class="url-display">${productGuideUrl}</div>
                    <div class="qr-code">
                        <img src="${qrImageUrl}" alt="QR Code for ${projectId}" />
                    </div>
                    <p>
                        <a href="${productGuideUrl}" class="btn" target="_blank">æµ‹è¯•é“¾æ¥</a>
                        <button class="btn secondary" onclick="copyToClipboard('${productGuideUrl}')">å¤åˆ¶é“¾æ¥</button>
                    </p>
                `;
                qrResults.appendChild(projectDiv);
            });

            document.getElementById('qr-section').className = 'test-section success';
        }

        // é¡¹ç›®è®¿é—®æµ‹è¯•
        function testProjectAccess() {
            const projectResults = document.getElementById('project-results');
            const testUrls = [
                `${window.location.origin}${window.location.pathname}#/view/p1`,
                `${window.location.origin}${window.location.pathname}#/view/proj_1`,
                `${window.location.origin}${window.location.pathname}#/video/p1`
            ];

            testUrls.forEach(url => {
                const urlDiv = document.createElement('div');
                urlDiv.innerHTML = `
                    <p><strong>æµ‹è¯•URL:</strong> ${url}</p>
                    <p><a href="${url}" class="btn" target="_blank">è®¿é—®æµ‹è¯•</a></p>
                `;
                projectResults.appendChild(urlDiv);
            });

            document.getElementById('project-section').className = 'test-section success';
        }

        // APIè¿æ¥æµ‹è¯•
        function testAPIConnection() {
            const apiResults = document.getElementById('api-results');
            const apiKey = localStorage.getItem('zhipuApiKey');
            
            if (!apiKey) {
                apiResults.innerHTML = `
                    <p><span class="status error">APIå¯†é’¥ç¼ºå¤±</span></p>
                    <p>æœªåœ¨localStorageä¸­æ‰¾åˆ°'zhipuApiKey'</p>
                    <p>ç”¨æˆ·æ‰«ç åå°†çœ‹åˆ°APIå¯†é’¥é…ç½®æç¤º</p>
                `;
                document.getElementById('api-section').className = 'test-section warning';
            } else {
                apiResults.innerHTML = `
                    <p><span class="status success">APIå¯†é’¥å·²é…ç½®</span></p>
                    <p>å¯†é’¥: ${apiKey.substring(0, 20)}...</p>
                    <p>ç”¨æˆ·æ‰«ç åå¯ä»¥æ­£å¸¸ä½¿ç”¨AIæœåŠ¡</p>
                `;
                document.getElementById('api-section').className = 'test-section success';
            }
        }

        // ä¿®å¤å»ºè®®
        function generateFixSuggestions() {
            const fixResults = document.getElementById('fix-results');
            const hostname = window.location.hostname;
            const port = window.location.port;
            const apiKey = localStorage.getItem('zhipuApiKey');
            
            let suggestions = [];
            
            // æ£€æŸ¥ç¯å¢ƒ
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                suggestions.push({
                    type: 'warning',
                    title: 'å¼€å‘ç¯å¢ƒæ£€æµ‹',
                    content: 'å½“å‰åœ¨å¼€å‘ç¯å¢ƒï¼Œéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒæ—¶URLä¼šè‡ªåŠ¨é€‚é…'
                });
            }
            
            // æ£€æŸ¥ç«¯å£
            if (port && port !== '80' && port !== '443') {
                suggestions.push({
                    type: 'success',
                    title: 'ç«¯å£é…ç½®æ­£ç¡®',
                    content: `å·²æ­£ç¡®è¯†åˆ«ç«¯å£ ${port}ï¼ŒäºŒç»´ç URLå°†åŒ…å«æ­¤ç«¯å£`
                });
            }
            
            // æ£€æŸ¥APIå¯†é’¥
            if (!apiKey) {
                suggestions.push({
                    type: 'error',
                    title: 'APIå¯†é’¥æœªé…ç½®',
                    content: 'éœ€è¦åœ¨è®¾ç½®é¡µé¢é…ç½®æ™ºè°±AIå¯†é’¥ï¼Œæˆ–è€…ç”¨æˆ·æ‰«ç åä¼šçœ‹åˆ°é…ç½®æç¤º'
                });
            }
            
            // æ·»åŠ é€šç”¨å»ºè®®
            suggestions.push({
                type: 'success',
                title: 'è¿æ¥é—®é¢˜å·²ä¿®å¤',
                content: 'å·²ä¿®å¤äºŒç»´ç URLç¡¬ç¼–ç ç«¯å£é—®é¢˜ï¼Œç°åœ¨æ”¯æŒæ‰€æœ‰ç¯å¢ƒéƒ¨ç½²'
            });
            
            suggestions.forEach(suggestion => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.innerHTML = `
                    <p><span class="status ${suggestion.type}">${suggestion.title}</span></p>
                    <p>${suggestion.content}</p>
                `;
                fixResults.appendChild(suggestionDiv);
            });
            
            document.getElementById('fix-section').className = 'test-section success';
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
        window.onload = function() {
            detectEnvironment();
            testQRGeneration();
            testProjectAccess();
            testAPIConnection();
            generateFixSuggestions();
        };
    </script>
</body>
</html>